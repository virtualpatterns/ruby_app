require 'rubygems'
require "bundler/gem_tasks"
require 'bundler/setup'

require 'rake'

require 'ruby_app/application'
require 'ruby_app/request'

namespace :ruby_app do

  desc 'Monitor log'
  task :monitor do |task|
    system("cd ./lib/ruby_app && > ./log/application.log && clear && tail -f ./log/application.log")
  end

  desc 'Create console'
  task :console do |task|
    system("cd ./lib/ruby_app && clear && bundle exec ../../bin/ruby_app console")
  end

  desc 'Run'
  task :run do |task|
    system("cd ./lib/ruby_app && clear && bundle exec ../../bin/ruby_app run")
  end

  desc 'Get version'
  task :version do |task|
    puts RubyApp::VERSION
  end

  desc 'Push to master, release, and increment version'
  task :release do |task|
      system "git push origin master && rake release"
      version_file = File.join(RubyApp::ROOT, %w[version.rb])
      RubyApp::VERSION =~ /(\d+)\.(\d+)\.(\d+)/
      system "sed 's|[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*|#{$1}.#{$2}.#{$3.to_i + 1}|g' < '#{version_file}' > '#{version_file}.out'; rm '#{version_file}'; mv '#{version_file}.out' '#{version_file}'"
      system "git commit --all --message='Incrementing version'"
  end

  namespace :test do

    namespace :features do

      desc 'Run feature tests generating a failure file'
      task :all do |task|
        system("bundle exec cucumber --format rerun --tags ~@broken --require features --out failures_out.txt; cat failures_out.txt")
      end

      desc 'Rerun failed feature tests'
      task :failures do |task|
        system("mv failures_out.txt failures_in.txt; bundle exec cucumber --format rerun --tags ~@broken --require features --out failures_out.txt @failures_in.txt; cat failures_out.txt")
      end

      desc 'Run feature tests for the given feature file'
      task :one, :file do |task, arguments|
        system("bundle exec cucumber --format pretty --tags ~@broken --require features '#{arguments.file}'")
      end

    end

    desc 'Run RSpec tests'
    task :specs, :file, :line do |task, arguments|
      if arguments.file
        if arguments.line
          system("bundle exec rspec #{arguments.file} --line_number=#{arguments.line} --format=documentation --colour")
        else
          system("bundle exec rspec #{arguments.file} --format=documentation --colour")
        end
      else
        system("bundle exec rspec spec/ --format=documentation --colour")
      end
    end

    desc 'Run all tests'
    task :all => ['ruby_app:test:specs',
                  'ruby_app:test:features:all']

  end

  namespace :cache do

    desc 'Create element caches'
    task :create do |task|
      RubyApp::Application.create!
      begin
        Dir.glob(File.join(File.dirname(__FILE__), %w[lib ruby_app elements ** *.rb])).each do |element_file|
          RubyApp::Request.create!
          begin
            RubyApp::Request.cache = true
            require element_file
            element_class = element_file.gsub(File.join(File.dirname(__FILE__), %w[lib]), '')
            element_class = element_class.gsub(/^\//, '')
            element_class = element_class.gsub(/\.rb$/, '')
            element_class = upcode(element_class)
            begin
              element_class = eval(element_class)
              element_class.render(:css) rescue puts "#{element_class}.render(:css) failed"
              element_class.render(:js) rescue puts "#{element_class}.render(:js) failed"
            rescue Exception => exception
              puts "#{element_class.inspect} failed - #{exception.message}"
            end
          ensure
            RubyApp::Request.destroy!
          end
        end
      ensure
        RubyApp::Application.destroy!
      end
    end

    desc 'Clear element caches'
    task :destroy_all do |task|
      system('find . -name ".cache" -print | xargs rm -rf')
    end

    def upcode(value)
      value = value.gsub(/\/(.?)/) { "::#{$1.upcase}" }
      value.gsub(/(?:^|_)(.)/) { $1.upcase }
    end

  end

end

